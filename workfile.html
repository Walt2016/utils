<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta http-equiv="X-UA-Compatible" content="ie=edge"> -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Document</title>
    <link rel="stylesheet" href="index.css">
    <style>
        .hide {
            display: none
        }

        .block {
            margin-top: 10px;
            width: 400px;
        }

        .block .title {
            border-bottom: 1px solid #979797;
            font-weight: bolder
        }

        .block .rangeInput,
        .block .listInput,
        .block .tips {
            display: flex;
            flex-wrap: wrap;
            margin-top: 4px;
        }
        .block .listInput .listInput_group{
            display: flex;
            flex-wrap: wrap;
            flex: 1;
        }

        .block .rangeInput .label,
        .block .listInput .label,
        .block .tips .label {
            width: 80px;
        }

        .rangeInput .rangeInput_item,
        .listInput .listInput_item {
            width: 50px;
            border: 1px solid #ccc;
            height: 25px;
            line-height: 25px;
            font-size: 12px;
            padding: 0px 2px 0px 2px;
            position: relative;
            margin-right: 2px;
        }

        /* .listInput .listInput_item[disable]{
            background: #eee;
        } */
        .listInput .listInput_item .icon {
            position: absolute;
            right: 2px;
            top: -2px;
            color: #d78d85;
        }

        .listInput .listInput_item .icon:hover {
            cursor: pointer;
            color: red;
        }

        .listInput .listInput_item[disable]:after {
            content: "x";
            position: absolute;
            right: 2px;
            top: -2px;
        }

        .listInput .listInput_item[disable]:hover:after {
            color: red;
        }

        .rangeInput .rangeInput_item[contenteditable],
        .listInput .listInput_item[contenteditable] {
            border: 1px solid #ccc;
            width: 50px;
        }
    </style>
</head>

<body>
    <div class="nav"></div>
    <div class="blockList"></div>
    <div class="result"></div>
    <div class="hide" id="dialog">

        <div>保存</div>
        <input value="" type="text" name="from" placeholder="from">
        <div class="btn" name="btn" id="saveWorkfile">save</div>

    </div>
    <script src="utils.js"></script>
    <script>
        var _fn = function (cls) {
            switch (true) {
                case /^\.\w+/.test(cls):
                    return "class"
                    break;
                case /^#\w+/.test(cls):
                    return "id"
                    break;
                    // case _.type(cls)==""

            }
        }

        isDOM = function (obj) {
            if (typeof HTMLElement === 'object') {
                return obj instanceof HTMLElement;
            }
            return obj && typeof obj === 'object' && obj.nodeType === 1 && typeof obj.nodeName === 'string';
        }

        var isDOM = (typeof HTMLElement === 'object') ?
            function (obj) {
                return obj instanceof HTMLElement;
            } :
            function (obj) {
                return obj && typeof obj === 'object' && obj.nodeType === 1 && typeof obj.nodeName === 'string';
            }



        console.log(_fn("div.test"))
        console.log(_fn(".test"))
        console.log(_fn("#test"))

        console.log(_fn(_.query("#dialog")))
        console.log(_.type(_.query("#dialog")))



        var subject = [{
                label: "subject1",
                filters: [1, 3]
            },
            {
                label: "subject2",
                filters: [1, 2]
            },
            {
                label: "subject3",
                filters: [1, 2, 3]
            }
        ]

        var filterBlocks = [{
                id: 1,
                label: "Office Code",
                inputs: [{
                        label: "include range",
                        type: "range"
                    },
                    {
                        label: "include list",
                        type: "list",
                        size: 1
                    }
                ]
            }, {
                id: 2,
                label: "Acceptance No",
                inputs: [{
                        label: "include list",
                        type: "includelist",
                        size: 1
                    },
                    {
                        label: "include range",
                        type: "includerange"
                    }, {
                        label: "omit list",
                        type: "omitlist",
                        size: 1
                    },
                    {
                        label: "omit range",
                        type: "omitrange"
                    },

                ]
            }, {
                id: 3,
                label: "UW Year",
                inputs: [{
                        label: "include range",
                        type: "includerange"
                    },
                    {
                        label: "include list",
                        type: "includelist",
                        size: 1
                    }
                ]
            }, {
                id: 4,
                label: "RI Period",
                inputs: [{
                        label: "range",
                        type: "range"
                    },
                    {
                        label: "compare factor 1",
                        type: "select",
                        options:["P-Period","I-Inception Date","R-Renewal Date"]
                    }
                ]
            },
            {
                id: 5,
                label: "Location of Risk",
                inputs: [{
                        label: "include list",
                        type: "includelist",
                        size: 1
                    }, {
                        label: "omit list",
                        type: "omitlist",
                        size: 1
                    },
                    {
                        label: "N.B.",
                        type: "tips",
                        content: "999-select All,wild character is available.eg.'64*'"

                    }
                ]
            }
        ]

        var selectBlocks = [];



        var _select = function () {
            var workfile = _.storage.get("workfile") || subject;
            var select = _.select([""].concat(_.map(workfile, function (t, i) {
                return {
                    value: t.filters,
                    label: t.label
                }
            })), function (val) {
                selectBlocks = filterBlocks.filter(function (t) {
                    return val.indexOf(t.id) >= 0
                })
                console.log(selectBlocks)

                var checks = _.queryAll("input[type='checkbox']", ".namelist");
                console.log(checks)
                checks && checks.forEach(function (t) {
                    t.checked = false;
                })
                var ids = val.split(",")
                ids && ids.forEach(function (t) {
                    var checkbox = _.query("#checkobx_" + t)
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                })
            })
            return select
        }

        var select = _select();

        var ul = _.ul(_.map(filterBlocks, function (t) {
            return _.li(_.checkbox({
                label: t.label,
                id: "checkobx_" + t.id,
                blockId: t.id
            }))
        }), {
            "class": "namelist"
        }, {
            click: function (e) {
                var el = e.target;
                console.log(el)
            }
        })
        var getBlock = function (id) {
            return filterBlocks.filter(function (t) {
                return t.id == id
            })[0]
        }

        var tbn = _.btn("next", {
            name: "btn"
        }, {
            click: function (e) {
                console.log(e.target)
                var ckbs = _.queryAll(".checkbox:checked", ".namelist")
                _.empty(".blockList")
                _.forEach(ckbs, function (t) {
                    var blockId = Number(_.get(t, "blockId"))
                    var block = getBlock(blockId)
                    _block(block)

                    // _block(_.get(t, "label"))
                })
                if (ckbs.length > 0) {
                    _submitBtn()
                }
            }
        })
        _.append(".nav", [select, ul, tbn])
        var _block = function (block) {
            var title = _.div(block.label, {
                "class": "title"
            })
            var blockItems = [title]
            var blockId = "b" + block.id;
            var inputs = block.inputs;

            inputs.forEach(function (t, i) {

                var type = t.type;
                var label = t.label || type
                var size = t.size || 1;
                var _id = function (i) {
                    return [blockId, type, i].join("_")
                }
                var tips = t.tips;
                var content = t.content;
                var options=t.options;

                switch (t.type) {
                    case "range":
                    case "includerange":
                    case "omitrange":
                        var range = _.rangeInput({
                            label: label,
                            from: {
                                placeholder: "from",
                                id: _id(i)
                            },
                            to: {
                                placeholder: "to",
                                id: _id(i + 1)
                            }
                        })
                        blockItems.push(range)
                        break;
                    case "list":
                    case "includelist":
                    case "omitlist":
                        var list = _.listInput({
                            label: label,
                            size: size,
                            id: _id(i)
                        })
                        blockItems.push(list)
                        break;
                    case "tips":
                        var tips = _.div([_.div(label, {
                            "class": "label"
                        }), _.div(content, {
                            "class": "content"
                        })], {
                            "class": type
                        })
                        blockItems.push(tips)
                        break;
                    case "select":

                    // var label=;
                        var select=_.div([_.div(label, {
                            "class": "label"
                        }),_.select(options)]); 

                        //
                    blockItems.push(select)
                        break;
                }
            })


            var wrap = _.div(blockItems, {
                "class": "block",
                id: blockId
            })

            _.append(".blockList", wrap)

        }
        var _submitBtn = function () {
            var btn = _.btn("查询", {
                name: "btn"
            }, {
                click: function (e) {
                    var el = e.target;
                    var blockList = _.closest(el, ".blockList");

                    var title = _.query(".title", blockList)
                    title = title.innerText;

                    // var from = _.query("input[name='from']").value
                    // var to = _.query("input[name='to']").value
                    var from = _.query("[name='from']").innerText
                    var to = _.query("[name='to']").innerText

                    var range = ""; // "WHERE [column_name] BETWEEN from AND to"
                    if (from && !to) {
                        range = "WHERE [column_name] >= from"
                    }
                    if (!from && to) {
                        range = "WHERE [column_name] <= to"
                    }
                    if (from && to) {
                        range = "WHERE [column_name] BETWEEN from AND to"
                    }

                    range = range.replace("column_name", title)
                    range = range.replace("from", from)
                    range = range.replace("to", to)


                    var list = "WHERE [column_name] IN (values)"
                    list = list.replace("column_name", title)

                    var items = _.queryAll("input[name='item']")
                    var vals = []
                    _.forEach(items, function (t) {
                        t.value && vals.push(t.value)
                    })
                    if (vals.length > 0) {
                        list = list.replace("values", vals)
                    } else {
                        list = ""
                    }

                    _.empty(".result")
                    _.append(".result", [range, list])
                }
            })

            var btn2 = _.btn("保存workfile", {
                "class": "btn"
            }, {
                click: function () {
                    var dialog = _.query("#dialog")
                    _.show(dialog)

                }
            })
            _.append(".blockList", [btn, btn2])
        }
        var saveWorkfile = _.query("#saveWorkfile")
        _.addEvent("click", saveWorkfile, function () {
            var dialog = _.query("#dialog")
            var name = _.query("input", dialog).value

            _.hide(dialog)

            var workfile = _.storage.get("workfile");
            if (workfile) {

                workfile.push({
                    label: name
                })
                console.log(workfile)
                _.storage.set("workfile", workfile)

                _.replace(select, _select())

            } else {

                _.storage.set("workfile", subject)
            }
        })
    </script>
</body>

</html>